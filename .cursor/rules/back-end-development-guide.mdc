---
description: FastAPI å¾Œç«¯é–‹ç™¼æŒ‡å—ã€‚æŒ‡å° AI åœ¨é–‹ç™¼æˆ–ä¿®æ”¹å¾Œç«¯ API æ™‚ï¼Œéµå¾ªå°ˆæ¡ˆçš„çµæ§‹ã€API è¨­è¨ˆã€æ•¸æ“šæ¨¡å‹ã€éŒ¯èª¤è™•ç†åŠæ¸¬è©¦æœ€ä½³å¯¦è¸ï¼Œç¢ºä¿é«˜æ•ˆã€é«˜å“è³ªçš„å¾Œç«¯é–‹ç™¼ã€‚
globs: 
alwaysApply: false
---
# FastAPI å¾Œç«¯é–‹ç™¼èˆ‡å¯¦æ–½æŒ‡å—

## ğŸ¯ å°ˆå®¶åˆ†æèˆ‡èƒŒæ™¯
- **æŠ€è¡“é¸å‹æ·±å±¤åŸå› **: FastAPI å› å…¶é«˜æ€§èƒ½ã€æ˜“æ–¼å­¸ç¿’å’Œé–‹ç™¼æ•ˆç‡é«˜è€Œæˆç‚ºç¾ä»£ Python å¾Œç«¯é–‹ç™¼çš„é¦–é¸ã€‚çµåˆ Pydantic é€²è¡Œæ•¸æ“šé©—è­‰å’Œåºåˆ—åŒ–ï¼Œä»¥åŠå…§å»ºçš„ OpenAPI/Swagger æ–‡æª”è‡ªå‹•ç”Ÿæˆï¼Œæ¥µå¤§ç°¡åŒ–äº† API é–‹ç™¼ã€‚
- **æ¥­ç•Œæœ€ä½³å¯¦è¸èˆ‡æ¨™æº–**: éµå¾ª RESTful API è¨­è¨ˆåŸå‰‡ï¼Œå¼·èª¿æ¥å£çš„æ¸…æ™°æ€§ã€ä¸€è‡´æ€§å’Œç‹€æ…‹ç„¡é—œæ€§ã€‚åˆ©ç”¨ä¾è³´æ³¨å…¥ (Dependency Injection) å¯¦ç¾æ¨¡çµ„åŒ–å’Œå¯æ¸¬è©¦æ€§ã€‚
- **æ ¸å¿ƒæ¦‚å¿µèˆ‡å¤šå¹´å¯¦æˆ°ç¶“é©—ç¸½çµ**: é‡è¦–æ•¸æ“šæ¨¡å‹èˆ‡æ•¸æ“šåº«æ“ä½œçš„è§£è€¦ï¼Œå–„ç”¨ ORM/ODM (SQLModel) ç°¡åŒ–æ•¸æ“šäº¤äº’ã€‚å¼·èª¿éŒ¯èª¤è™•ç†çš„çµ±ä¸€æ€§èˆ‡ç”¨æˆ¶å‹å¥½æ€§ï¼Œä¸¦å°‡æ—¥èªŒè¨˜éŒ„ä½œç‚ºæ‡‰ç”¨ç¨‹å¼å¯è§€æ¸¬æ€§çš„é‡è¦ç’°ç¯€ã€‚

## ğŸ” æ ¸å¿ƒå¯¦æ–½ç­–ç•¥

### æŠ€è¡“æ¶æ§‹è¨­è¨ˆ
- **å°ˆæ¡ˆçµæ§‹**:
    - `src/magentic_ui/backend/web/routes/`: å­˜æ”¾æ‰€æœ‰ FastAPI è·¯ç”±å®šç¾©ã€‚
    - `src/magentic_ui/backend/datamodel/db.py`: å®šç¾© SQLModel æ•¸æ“šåº«æ¨¡å‹ã€‚
    - `src/magentic_ui/backend/database/db_manager.py`: è™•ç†æ•¸æ“šåº«é€£æ¥èˆ‡æ“ä½œã€‚
    - `src/magentic_ui/backend/teammanager/teammanager.py`: æ ¸å¿ƒæ¥­å‹™é‚è¼¯ã€‚
    - `src/magentic_ui/backend/utils/utils.py`: å­˜æ”¾é€šç”¨å·¥å…·å‡½æ•¸ã€‚
- **æ¨¡çµ„åŒ–è¨­è¨ˆ**: å°‡ä¸åŒçš„æ¥­å‹™åŠŸèƒ½æ¨¡çµ„åŒ–ï¼Œæ¯å€‹æ¨¡çµ„è² è²¬ç‰¹å®šåŠŸèƒ½ï¼Œå¦‚ç”¨æˆ¶ç®¡ç†ã€æœƒè©±ç®¡ç†ã€åœ˜éšŠç®¡ç†ç­‰ã€‚
- **ä¾è³´æ³¨å…¥**: å……åˆ†åˆ©ç”¨ FastAPI çš„ä¾è³´æ³¨å…¥ç³»çµ±ï¼Œç®¡ç†æ•¸æ“šåº«æœƒè©±ã€é…ç½®å’Œå…¶ä»–å…±äº«è³‡æºã€‚
- **API ç‰ˆæœ¬æ§åˆ¶**: è€ƒæ…®åœ¨ URL æˆ– Header ä¸­å¼•å…¥ API ç‰ˆæœ¬ï¼Œä»¥æ‡‰å°æœªä¾†éœ€æ±‚è®Šæ›´ã€‚

### é–‹ç™¼å¯¦è¸è¦ç¯„
- **ç¨‹å¼ç¢¼çµ„ç¹”**: æŒ‰ç…§åŠŸèƒ½åŠƒåˆ†æª”æ¡ˆå’Œç›®éŒ„ï¼Œä¿æŒç¨‹å¼ç¢¼çš„å…§èšæ€§å’Œæ¨¡å¡ŠåŒ–ã€‚
- **æª”æ¡ˆå‘½å**: æ¡ç”¨å°å¯«è›‡å½¢å‘½åæ³• (snake_case)ï¼Œå¦‚ `user_routes.py`, `plan_model.py`ã€‚
- **ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥**: éµå¾ªå°ˆæ¡ˆçš„ `git-workflow-guide.mdc`ï¼Œä½¿ç”¨åŠŸèƒ½åˆ†æ”¯é€²è¡Œé–‹ç™¼ï¼Œä¸¦é€šé Squash Merge åˆä½µåˆ°ä¸»åˆ†æ”¯ã€‚

## ğŸ’» å…·é«”å¯¦ç¾æŒ‡å¼•

### ç’°å¢ƒé…ç½®
- **Python è™›æ“¬ç’°å¢ƒ**: å»ºè­°ä½¿ç”¨ `uv` æˆ– `pipenv` ç®¡ç†å°ˆæ¡ˆä¾è³´ã€‚
    ```bash
    uv venv
    source .venv/bin/activate
    uv pip install -e ".[dev]"
    ```
- **æ•¸æ“šåº«**: ä½¿ç”¨ SQLite é€²è¡Œæœ¬åœ°é–‹ç™¼ï¼ŒSQLModel å°‡æœƒè‡ªå‹•è™•ç†æ•¸æ“šåº«çš„é€£æ¥å’Œé·ç§»ã€‚
- **ç’°å¢ƒè®Šæ•¸**: ä½¿ç”¨ `.env` æª”æ¡ˆç®¡ç†æ•æ„Ÿè³‡è¨Šå’Œç’°å¢ƒç‰¹å®šé…ç½®ã€‚
    ```ini
    # .env ç¯„ä¾‹
    DATABASE_URL="sqlite:///./sql_app.db"
    # å…¶ä»– FastAPI æˆ–æ‡‰ç”¨ç›¸é—œçš„ç’°å¢ƒè®Šæ•¸
    ```

### ç¨‹å¼ç¢¼å¯¦ç¾
- **æ•¸æ“šæ¨¡å‹ (SQLModel)**:
    ```python
    # src/magentic_ui/backend/datamodel/db.py ç¯„ä¾‹
    from typing import Optional
    from sqlmodel import Field, SQLModel

    class Hero(SQLModel, table=True):
        id: Optional[int] = Field(default=None, primary_key=True)
        name: str = Field(index=True)
        secret_name: str
        age: Optional[int] = Field(default=None, index=True)
    ```
- **API è·¯ç”±**:
    ```python
    # src/magentic_ui/backend/web/routes/heroes.py ç¯„ä¾‹
    from fastapi import APIRouter, Depends
    from sqlmodel import Session
    from magentic_ui.backend.datamodel.db import Hero
    from magentic_ui.backend.web.deps import get_session

    router = APIRouter()

    @router.post("/heroes/", response_model=Hero)
    def create_hero(*, hero: Hero, session: Session = Depends(get_session)):
        session.add(hero)
        session.commit()
        session.refresh(hero)
        return hero

    @router.get("/heroes/", response_model=list[Hero])
    def read_heroes(*, session: Session = Depends(get_session)):
        return session.query(Hero).all()
    ```
- **ä¾è³´æ³¨å…¥**:
    ```python
    # src/magentic_ui/backend/web/deps.py ç¯„ä¾‹
    from sqlmodel import Session, create_engine
    from magentic_ui.backend.datamodel.db import SQLModel

    DATABASE_URL = "sqlite:///./sql_app.db" # æ‡‰å¾é…ç½®è®€å–
    engine = create_engine(DATABASE_URL, echo=True)

    def create_db_and_tables():
        SQLModel.metadata.create_all(engine)

    def get_session():
        with Session(engine) as session:
            yield session
    ```
- **éŒ¯èª¤è™•ç†**:
    ```python
    # src/magentic_ui/backend/web/app.py ä¸­è¨»å†Šå…¨å±€ç•°å¸¸è™•ç†å™¨
    from fastapi import FastAPI, Request, HTTPException
    from fastapi.responses import JSONResponse

    app = FastAPI()

    @app.exception_handler(HTTPException)
    async def http_exception_handler(request: Request, exc: HTTPException):
        return JSONResponse(
            status_code=exc.status_code,
            content={"message": exc.detail},
        )
    ```
- **æ—¥èªŒè¨˜éŒ„**: æ•´åˆ `loguru`ã€‚
    ```python
    # utils/logger.py (ç¯„ä¾‹)
    from loguru import logger

    logger.add("file.log", rotation="10 MB", level="INFO")
    ```

### å¸¸è¦‹é™·é˜±èˆ‡è§£æ±ºæ–¹æ¡ˆ
- **N+1 å•é¡Œ**: é©ç•¶ä½¿ç”¨ ORM çš„ `selectinload` æˆ– `joinedload` é åŠ è¼‰é—œè¯æ•¸æ“šã€‚
- **å¯†ç¢¼å®‰å…¨**: æ°¸é å°å¯†ç¢¼é€²è¡Œå“ˆå¸Œè™•ç†ï¼Œä¸è¦æ˜æ–‡å­˜å„²ã€‚
- **CORS å•é¡Œ**: æ­£ç¢ºé…ç½® FastAPI çš„ `CORS` ä¸­é–“ä»¶ã€‚

## ğŸš€ å°ˆå®¶å¿ƒè·¯æ­·ç¨‹
- **æŠ€è¡“æ±ºç­–çš„æ¬Šè¡¡**: åœ¨é¸æ“‡ ORM æ™‚ï¼ŒSQLModel æä¾›äº† Pydantic å’Œ SQLAlchemy çš„è‰¯å¥½çµåˆï¼Œç°¡åŒ–äº†æ•¸æ“šæ¨¡å‹å®šç¾©å’Œæ•¸æ“šåº«æ“ä½œï¼ŒåŒæ™‚ä¿ç•™äº† SQLAlchemy çš„å¼·å¤§åŠŸèƒ½ï¼Œé€™æ˜¯ç¶œåˆè€ƒæ…®é–‹ç™¼æ•ˆç‡å’Œéˆæ´»æ€§å¾Œçš„å„ªé¸ã€‚
- **æŒçºŒé›†æˆèˆ‡éƒ¨ç½²**: å¼·çƒˆå»ºè­°å°‡å–®å…ƒæ¸¬è©¦å’Œæ•´åˆæ¸¬è©¦ç´å…¥ CI/CD æµç¨‹ï¼Œç¢ºä¿æ¯æ¬¡æäº¤éƒ½èƒ½è‡ªå‹•åŒ–é©—è­‰ç¨‹å¼ç¢¼å“è³ªã€‚
- **æ€§èƒ½ç›£æ§**: éš¨è‘—å°ˆæ¡ˆè¦æ¨¡æ“´å¤§ï¼Œé›†æˆ APM (Application Performance Monitoring) å·¥å…·è‡³é—œé‡è¦ï¼Œä»¥ä¾¿åŠæ™‚ç™¼ç¾å’Œè§£æ±ºæ€§èƒ½ç“¶é ¸ã€‚

## ğŸ“‹ å“è³ªæª¢æ ¸æ¨™æº–
- **åŠŸèƒ½å®Œæ•´æ€§**: æ‰€æœ‰ API ç«¯é»æ˜¯å¦æŒ‰é æœŸå·¥ä½œï¼Œä¸¦è™•ç†æ‰€æœ‰é‚Šç·£æƒ…æ³ã€‚
- **æ€§èƒ½æŒ‡æ¨™**: API éŸ¿æ‡‰æ™‚é–“æ˜¯å¦ç¬¦åˆé æœŸï¼Œæ•¸æ“šåº«æŸ¥è©¢æ˜¯å¦å„ªåŒ–ã€‚
- **å®‰å…¨æ€§**: èªè­‰æˆæ¬Šæ©Ÿåˆ¶æ˜¯å¦å¥å£¯ï¼Œæ•¸æ“šè¼¸å…¥æ˜¯å¦ç¶“éå……åˆ†é©—è­‰å’Œæ¸…ç†ã€‚
- **å¯ç¶­è­·æ€§**: ç¨‹å¼ç¢¼æ˜¯å¦æ¸…æ™°ã€æ¨¡çµ„åŒ–ï¼Œéµå¾ª PEP 8 è¦ç¯„ï¼Œä¸¦æœ‰å……è¶³çš„è¨»é‡‹ã€‚
- **æ¸¬è©¦è¦†è“‹ç‡**: ç¢ºä¿æ ¸å¿ƒæ¥­å‹™é‚è¼¯å’Œ API ç«¯é»æœ‰è¶³å¤ çš„æ¸¬è©¦è¦†è“‹ã€‚
